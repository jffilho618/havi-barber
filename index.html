<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Havi Barber</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Tela 1 -->
<section id="tela-1" class="active">
    <div class="header">
        <img src="./imagens/logo.png.jpg" alt="Logo Havi Barber">
        <p>üìç Rua S√£o Domingos N¬∫ 807 - Cidade Nova</p>
        <button id="meus-agendamentos-btn" onclick="abrirModalTelefone()">Meus Agendamentos</button>
        <!-- Bot√£o de login para o barbeiro -->
        <a href="/login" class="btn login-button">Login como Barbeiro</a>

    </div>

    <h2>Selecione um servi√ßo:</h2>

    <div class="service">
        <div class="icon">
            <img src="./imagens/corte.png" alt="Corte">
        </div>
        <p>CORTE <span>R$ 20,00</span></p>
        <button data-servico="Corte" data-preco="R$ 20,00" onclick="changeScreen(this)">Agendar</button>
    </div>

    <div class="service">
        <div class="icon">
            <img src="./imagens/navalha.png" alt="Navalhado">
        </div>
        <p>NAVALHADO <span>R$ 25,00</span></p>
        <button data-servico="Navalhado" data-preco="R$ 25,00" onclick="changeScreen(this)">Agendar</button>
    </div>

    <div class="service">
        <div class="icon">
            <img src="./imagens/barbaecorte.png" alt="Corte + Barba">
        </div>
        <p>CORTE + BARBA <span>R$ 45,00</span></p>
        <button data-servico="Corte + Barba" data-preco="R$ 45,00" onclick="changeScreen(this)">Agendar</button>
    </div>

    <div class="service">
        <div class="icon">
            <img src="./imagens/pigmentacao.png" alt="Pigmenta√ß√£o">
        </div>
        <p>PIGMENTA√á√ÉO <span>R$ 25,00</span></p>
        <button data-servico="Pigmenta√ß√£o" data-preco="R$ 25,00" onclick="changeScreen(this)">Agendar</button>
    </div>

    <div class="service">
        <div class="icon">
            <img src="./imagens/sombrancelha.png" alt="Sobrancelha">
        </div>
        <p>SOBRANCELHA <span>R$ 5,00</span></p>
        <button data-servico="Sobrancelha" data-preco="R$ 5,00" onclick="changeScreen(this)">Agendar</button>
    </div>
</section>

<!-- Tela 2 -->
<section id="tela-2">
    <div class="header">
        <img src="./imagens/logo.png.jpg" alt="Logo Havi Barber">
        <p>üìç Rua S√£o Domingos N¬∫ 807 - Cidade Nova</p>
        <button onclick="changeScreen()">Voltar</button>
    </div>

    <h2>Agende seu hor√°rio:</h2>

    <form id="agendamentoForm">
        <label for="nome">Nome</label>
        <input type="text" id="nome" name="nome" required>

        <label for="telefone">Telefone</label>
        <input type="tel" id="telefone" name="telefone" required>

        <label for="data">Data</label>
        <input type="date" id="data" name="data" required onchange="carregarHorariosDisponiveis()">

        <label for="horario">Hor√°rio</label>
        <div class="horarios">
            <button type="button" onclick="setHorario('09:00')">09:00</button>
            <button type="button" onclick="setHorario('09:40')">09:40</button>
            <button type="button" onclick="setHorario('10:20')">10:20</button>
            <button type="button" onclick="setHorario('11:00')">11:00</button>
            <button type="button" onclick="setHorario('13:00')">13:00</button>
            <button type="button" onclick="setHorario('13:40')">13:40</button>
            <button type="button" onclick="setHorario('14:20')">14:20</button>
            <button type="button" onclick="setHorario('15:00')">15:00</button>
            <button type="button" onclick="setHorario('15:40')">15:40</button>
            <button type="button" onclick="setHorario('16:20')">16:20</button>
            <button type="button" onclick="setHorario('17:00')">17:00</button>
            <button type="button" onclick="setHorario('17:40')">17:40</button>
            <button type="button" onclick="setHorario('18:20')">18:20</button>
            <button type="button" onclick="setHorario('19:00')">19:00</button>
        </div>

        <input type="hidden" id="horario" name="horario" required>

        <button type="button" onclick="confirmarAgendamento()">Confirmar Agendamento</button>
    </form>
</section>

<!-- Modal para Capturar Telefone -->
<div id="telefoneModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModal()">&times;</span>
        <h2>Confirme o seu n√∫mero</h2>
        <p>Por favor, escreva o n√∫mero do celular usado para agendar o servi√ßo.</p>
        <label for="telefoneModalInput">Celular (WhatsApp)</label>
        <input type="tel" id="telefoneModalInput" name="telefoneModalInput" required>
        <div class="modal-buttons">
            <button id="voltarBtn" class="modal-button" onclick="fecharModal()">Voltar</button>
            <button id="confirmarBtn" class="modal-button confirm" onclick="buscarAgendamentosPorTelefone()">Confirmar</button>
        </div>
    </div>
</div>

 <!-- Modal para Exibir Agendamentos  -->
 <div id="modal-agendamentos" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModalAgendamentos()">&times;</span>
        <h2>Agendamentos Futuros</h2>
        <div id="agendamento-corpo" class="cartao-container">
            <!-- Os cart√µes ser√£o inseridos aqui dinamicamente  -->
        </div>
    </div>
</div>


<script>

function carregarHorariosDisponiveis() {
    const data = document.getElementById('data').value;
    console.log('Data selecionada:', data);
    if (!data) return;

    fetch(`/horarios_disponiveis?data=${data}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na resposta da API');
            }
            return response.json();
        })
        .then(horarios => {
            console.log('Hor√°rios dispon√≠veis:', horarios);
            const horariosContainer = document.querySelector('.horarios');
            horariosContainer.innerHTML = ''; // Limpa hor√°rios anteriores

            // Obt√©m o hor√°rio atual
            const agora = new Date();
            const horaAtual = agora.getHours();
            const minutosAtual = agora.getMinutes();
            const horarioAtual = `${horaAtual < 10 ? '0' : ''}${horaAtual}:${minutosAtual < 10 ? '0' : ''}${minutosAtual}`;

            horarios.forEach(horario => {
                // Compara os hor√°rios dispon√≠veis com o hor√°rio atual
                if (data === new Date().toISOString().split('T')[0] && horario < horarioAtual) {
                    console.log(`Hor√°rio ${horario} n√£o ser√° exibido porque j√° passou.`);
                    return; // N√£o exibe hor√°rios que j√° passaram
                }

                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = horario;
                button.onclick = () => setHorario(horario);
                horariosContainer.appendChild(button);
            });
        })
        .catch(error => {
            console.error('Erro ao carregar hor√°rios:', error);
        });
}






    let servicoSelecionado = "";
    let precoSelecionado = "";

    // Armazena os hor√°rios agendados (independente do servi√ßo)
    const horariosAgendados = {};

    function changeScreen(button) {
        const tela1 = document.getElementById('tela-1');
        const tela2 = document.getElementById('tela-2');

        if (tela1.classList.contains('active')) {
            tela1.classList.remove('active');
            tela2.classList.add('active');

            servicoSelecionado = button.getAttribute('data-servico');
            precoSelecionado = button.getAttribute('data-preco');
        } else {
            tela2.classList.remove('active');
            tela1.classList.add('active');
        }
    }

    function setHorario(horarioSelecionado) {
        document.getElementById('horario').value = horarioSelecionado;

        const botoesHorarios = document.querySelectorAll('.horarios button');
        botoesHorarios.forEach((botao) => {
            botao.classList.remove('selected');
        });

        const botaoSelecionado = Array.from(botoesHorarios).find(
            (botao) => botao.textContent === horarioSelecionado
        );
        if (botaoSelecionado) {
            botaoSelecionado.classList.add('selected');
        }
    }

    // Fun√ß√£o para mostrar a mensagem de erro
    function mostrarErro(campo, mensagem) {
        const elementoErro = campo.nextElementSibling;
        if (elementoErro) {
            elementoErro.textContent = mensagem;
            elementoErro.style.color = 'red';
        }
    }

    // Fun√ß√£o para limpar a mensagem de erro
    function limparErro(campo) {
        const elementoErro = campo.nextElementSibling;
        if (elementoErro) {
            elementoErro.textContent = '';
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
    // Definindo a data m√≠nima no campo de data como a data atual
    const dataInput = document.getElementById('data');
    const hoje = new Date().toISOString().split('T')[0];  // Obt√©m a data atual no formato yyyy-mm-dd
    dataInput.setAttribute('min', hoje);  // Define o m√≠nimo do input de data como a data de hoje
});

async function confirmarAgendamento() {
    const nome = document.getElementById('nome');
    const telefone = document.getElementById('telefone');
    const data = document.getElementById('data');
    const horario = document.getElementById('horario');

    let camposValidos = true;

    // Verifica√ß√£o dos campos
    if (nome.value.trim() === '') {
        mostrarErro(nome, 'Nome √© obrigat√≥rio.');
        camposValidos = false;
    } else {
        limparErro(nome);
    }

    if (telefone.value.trim() === '') {
        mostrarErro(telefone, 'Telefone √© obrigat√≥rio.');
        camposValidos = false;
    } else {
        limparErro(telefone);
    }

    if (data.value.trim() === '') {
        mostrarErro(data, 'Data √© obrigat√≥ria.');
        camposValidos = false;
    } else {
        const hoje = new Date().toISOString().split('T')[0];  // Data atual no formato yyyy-mm-dd
        if (data.value < hoje) {
            mostrarErro(data, 'N√£o √© poss√≠vel agendar para uma data no passado.');
            camposValidos = false;
        } else {
            limparErro(data);
        }
    }

    if (horario.value.trim() === '') {
        mostrarErro(horario, 'Hor√°rio √© obrigat√≥rio.');
        camposValidos = false;
    } else {
        limparErro(horario);
    }

    // Se houver algum campo inv√°lido, n√£o prosseguir
    if (!camposValidos) {
        return;
    }

    // Log para verificar valores de data e hor√°rio
    console.log("Data selecionada:", data.value);
    console.log("Hor√°rio selecionado:", horario.value);

    const chaveAgendamento = `${data.value} ${horario.value}`;

    if (horariosAgendados[chaveAgendamento]) {
        console.log(`Hor√°rio indispon√≠vel: ${chaveAgendamento}`);
        alert(`O hor√°rio ${horario.value} do dia ${data.value} j√° est√° agendado. Por favor, escolha outro hor√°rio.`);
        return;
    }

    const confirmar = confirm(`Voc√™ deseja agendar para ${data.value} √†s ${horario.value}?`);

    if (confirmar) {
        const agendamento = {
            nome: nome.value,
            telefone: telefone.value,
            data: data.value,
            horario: horario.value,
            servico: servicoSelecionado,
            preco: precoSelecionado
        };

        try {
            const response = await fetch('/agendamentos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(agendamento),
            });

            console.log('Status da resposta:', response.status);
            console.log('Resposta OK:', response.ok);

            if (response.ok) {
                const dataResponse = await response.json();
                console.log('Agendamento confirmado:', dataResponse);

                horariosAgendados[chaveAgendamento] = true;

                // Verificar se nome, data e hor√°rio est√£o corretos antes de montar a mensagem
                console.log("Valores para mensagem WhatsApp:");
                console.log("Nome:", nome.value);
                console.log("Data:", data.value);
                console.log("Hor√°rio:", horario.value);

                // Monta a mensagem para o WhatsApp
                const mensagem = `Ol√°, meu nome √© ${nome.value}. Gostaria de confirmar o agendamento para ${data.value} √†s ${horario.value}. Meu telefone √© ${telefone.value}.`;
                const mensagemCodificada = encodeURIComponent(mensagem);
                const numeroWhatsapp = "5586995779567";
                const link = `https://wa.me/${numeroWhatsapp}?text=${mensagemCodificada}`;

                window.location.href = link;
            } else if (response.status === 409) {
                alert('O hor√°rio j√° foi agendado por outro cliente. Por favor, escolha outro hor√°rio.');
            } else {
                const errorText = await response.text();  // Tenta ler a resposta como texto
                console.error('Erro ao confirmar agendamento:', errorText);
                alert('Ocorreu um erro ao tentar confirmar o agendamento. Tente novamente.');
            }
        } catch (error) {
            console.error('Erro de comunica√ß√£o com o servidor:', error);
            alert('Erro de comunica√ß√£o com o servidor. Por favor, tente novamente mais tarde.');
        }
    } else {
        alert('Agendamento cancelado.');
    }
}



    // Fun√ß√£o para abrir o modal de telefone e buscar agendamentos
    function abrirModalTelefone() {
    const modal = document.getElementById('telefoneModal');
    modal.style.display = 'block';  // Exibe o modal
}

    function fecharModal() {
        const modal = document.getElementById('telefoneModal');
        modal.style.display = 'none';  // Esconde o modal
    }


    async function buscarAgendamentosPorTelefone() {
    const telefone = document.getElementById('telefoneModalInput').value;
    const tabelaBody = document.querySelector('#agendamento-corpo');

    // Valida√ß√£o mais robusta do telefone (exemplo para 10 ou 11 d√≠gitos)
    const telefoneRegex = /^\d{10,11}$/;
    if (!telefoneRegex.test(telefone)) {
        alert("Por favor, insira um n√∫mero de telefone v√°lido.");
        return;
    }

    try {
        // Faz uma requisi√ß√£o para a API com o telefone digitado
        const response = await fetch('/agendamentos/telefone', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ telefone })
        });

        // Verifica se houve algum erro na resposta
        if (!response.ok) {
            const error = await response.json();
            alert(error.message || 'Erro ao buscar agendamentos.');
            return;
        }

        const agendamentos = await response.json();
        tabelaBody.innerHTML = '';  // Limpa o corpo antes de inserir novos agendamentos

        // Verifica se h√° agendamentos
        if (agendamentos.length === 0) {
            const card = document.createElement('div');
            card.classList.add('card');
            card.textContent = 'Nenhum agendamento encontrado';
            tabelaBody.appendChild(card);
        } else {
            // Itera pelos agendamentos e cria um cart√£o para cada um
            agendamentos.forEach(agendamento => {
                // Cria um novo elemento de cart√£o
                const card = document.createElement('div');
                card.classList.add('card'); // Adiciona a classe de estilo para o cart√£o

                // Cria os elementos para exibir os dados
                const nome = document.createElement('h3');
                nome.textContent = agendamento.nome;

                const telefone = document.createElement('p');
                telefone.textContent = `Telefone: ${agendamento.telefone}`;

                const data = document.createElement('p');
                data.textContent = `Data: ${agendamento.data}`;

                const horario = document.createElement('p');
                horario.textContent = `Hor√°rio: ${agendamento.horario}`;

                const servico = document.createElement('p');
                servico.textContent = `Servi√ßo: ${agendamento.servico}`;

                const preco = document.createElement('p');
                preco.textContent = `Pre√ßo: ${agendamento.preco}`;

                // Cria o bot√£o de remover
                const removerButton = document.createElement('button');
                removerButton.textContent = 'Cancelar';
                removerButton.classList.add('remove-button'); // Adiciona a classe de estilo para o bot√£o;
                removerButton.onclick = () => verificarCancelamentoEremoverAgendamento(agendamento._id, agendamento.data, agendamento.horario);

                // Adiciona os elementos ao cart√£o
                card.appendChild(nome);
                card.appendChild(telefone);
                card.appendChild(data);
                card.appendChild(horario);
                card.appendChild(servico);
                card.appendChild(preco);
                card.appendChild(removerButton);

                // Adiciona o cart√£o ao corpo da tabela
                tabelaBody.appendChild(card);
            });
        }

        // Fecha o modal de telefone e exibe o modal de agendamentos
        document.getElementById('telefoneModal').style.display = 'none';
        document.getElementById('modal-agendamentos').style.display = 'block';

    } catch (error) {
        console.error('Erro ao buscar agendamentos:', error);
        alert('Ocorreu um erro ao buscar agendamentos.');
    }
}

async function verificarCancelamentoEremoverAgendamento(id, dataAgendamento, horarioAgendamento) {
    // Converte a data e hora do agendamento para um objeto Date
    const agendamentoDataHora = new Date(`${dataAgendamento}T${horarioAgendamento}`);
    
    // Obt√©m a data e hora atuais
    const dataHoraAtual = new Date();
    
    // Calcula a diferen√ßa em milissegundos
    const diferencaMillis = agendamentoDataHora - dataHoraAtual;
    
    // Converte a diferen√ßa para horas
    const diferencaHoras = diferencaMillis / (1000 * 60 * 60);

    // Verifica se a diferen√ßa √© maior ou igual a 1 hora
    if (diferencaHoras >= 1) {
        // Chama a fun√ß√£o de remover agendamento
        await removerAgendamento(id);
    } else {
        alert('Voc√™ s√≥ pode cancelar o agendamento at√© 1 hora antes do hor√°rio agendado.');
    }
}

async function removerAgendamento(id) {
    const confirma = confirm('Tem certeza que deseja remover este agendamento?');
    if (confirma) {
        try {
            const response = await fetch(`/agendamentos/${id}`, {
                method: 'DELETE',
            });

            if (response.ok) {
                alert('Agendamento removido com sucesso!');
                location.reload(); // Atualiza a p√°gina para refletir a remo√ß√£o
            } else {
                const error = await response.json();
                alert(error.message || 'Erro ao remover agendamento.');
            }
        } catch (error) {
            console.error('Erro ao remover agendamento:', error);
            alert('Ocorreu um erro ao tentar remover o agendamento.');
        }
    }
}



    function abrirModalAgendamentos() {
        const modalAgendamentos = document.getElementById('modal-agendamentos');
        modalAgendamentos.style.display = 'block';  // Exibe o modal de agendamentos
    }

    function fecharModalAgendamentos() {
        const modalAgendamentos = document.getElementById('modal-agendamentos');
        modalAgendamentos.style.display = 'none';  // Esconde o modal de agendamentos
    }

    window.onclick = function(event) {
        const modalTelefone = document.getElementById('telefoneModal');
        const modalAgendamentos = document.getElementById('modal-agendamentos');
        
        if (event.target === modalTelefone) {
            modalTelefone.style.display = 'none';
        }
        if (event.target === modalAgendamentos) {
            modalAgendamentos.style.display = 'none';
        }
    }



</script>

</body>
</html>